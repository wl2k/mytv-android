<!DOCTYPE html>
<html lang="zh">

    <head>
        <meta charset="utf-8">
        <meta
                content="width=device-width, initial-scale=1"
                name="viewport">
        <title>我的电视</title>
        <link
                href="/css"
                rel="stylesheet" />
        <script src="/js"></script>

        <style>
            .van-theme-dark body {
                color: #f5f5f5;
                background-color: black;
            }
        </style>
    </head>

    <body>
        <div
                class="min-h-100vh py-46px"
                id="app">
            <van-config-provider :theme="isDark ? 'dark' : undefined">
                <template v-if="settings">
                    <div class="p-20px pt-0">
                        <div class="ml-16px text-32px">我的电视</div>
                        <div class="ml-16px text-gray text-14px">{{ settings.appRepo }}</div>
                    </div>

                    <template v-if="tabActive === 'config'">
                        <van-cell-group
                                inset
                                title="通知">
                            <van-cell title="修改之前请先关闭应用的设置界面，否则会有冲突"></van-cell>
                            <van-cell title="以下设置修改后，需要重启应用生效"></van-cell>
                        </van-cell-group>

                        <van-cell-group
                                inset
                                title="直播源">
                            <van-cell title="自定义直播源">
                                <template #label>
                                    <van-space
                                            class="w-full"
                                            direction="vertical"
                                            size="small">
                                        <span>支持 m3u, txt</span>
                                        <van-field
                                                class="!p-0"
                                                placeholder="空表示默认"
                                                rows="2"
                                                type="textarea"
                                                v-model="settings.iptvSourceUrl"></van-field>
                                    </van-space>
                                </template>

                                <template #extra>
                                    <van-button
                                            @click="settings.iptvSourceCachedAt = 0; confirmSettings()"
                                            size="small"
                                            type="primary">推送
                                    </van-button>
                                </template>
                            </van-cell>
                        </van-cell-group>

                        <van-cell-group
                                inset
                                title="节目单">
                            <van-cell title="自定义节目单">
                                <template #label>
                                    <van-space
                                            class="w-full"
                                            direction="vertical"
                                            size="small">
                                        <span>支持 xml, xml.gz</span>
                                        <van-field
                                                class="!p-0"
                                                placeholder="空表示默认"
                                                rows="2"
                                                type="textarea"
                                                v-model="settings.epgXmlUrl"></van-field>
                                    </van-space>
                                </template>

                                <template #extra>
                                    <van-button
                                            @click="settings.epgXmlCachedAt = 0; settings.epgCachedHash = 0; confirmSettings()"
                                            size="small"
                                            type="primary">推送
                                    </van-button>
                                </template>
                            </van-cell>
                        </van-cell-group>

                        <van-cell-group
                                inset
                                title="播放器">
                            <van-cell title="自定义 User-Agent">
                                <template #label>
                                    <van-space
                                            class="w-full"
                                            direction="vertical"
                                            size="small">
                                        <van-field
                                                class="!p-0"
                                                placeholder="空表示默认"
                                                rows="2"
                                                type="textarea"
                                                v-model="settings.videoPlayerUserAgent"></van-field>
                                    </van-space>
                                </template>

                                <template #extra>
                                    <van-button
                                            @click="settings.epgXmlCachedAt = 0; settings.epgCachedHash = 0; confirmSettings()"
                                            size="small"
                                            type="primary">推送
                                    </van-button>
                                </template>
                            </van-cell>
                        </van-cell-group>

                        <van-cell-group
                                inset
                                title="DEBUG">
                            <van-cell title="上传 APK">
                                <template #extra>
                                    <van-uploader
                                            :after-read="uploaderAfterRead"
                                            accept=".apk"></van-uploader>
                                </template>
                            </van-cell>
                        </van-cell-group>
                    </template>

                    <template v-else-if="tabActive === 'log'">
                        <van-list>
                            <van-cell
                                    :key="item.time"
                                    :label="item.cause"
                                    v-for="item in settings.logHistory">
                                <template #title>
                                    <div class="flex flex-col gap-1">
                                        <div class="flex gap-1 items-center">
                                            <van-tag plain>{{ item.tag }}</van-tag>
                                            <van-tag plain>{{ item.level }}</van-tag>
                                        </div>
                                        <span>{{ item.message }}</span>
                                    </div>
                                </template>

                                <template #extra>
                                    <span text="gray">{{ dayjs(item.time).format('HH:mm:ss') }}
                                    </span>
                                </template>
                            </van-cell>
                        </van-list>
                    </template>

                    <van-tabbar v-model="tabActive">
                        <van-tabbar-item
                                icon="tv-o"
                                name="config">配置
                        </van-tabbar-item>
                        <van-tabbar-item
                                icon="list-switch"
                                name="log">日志
                        </van-tabbar-item>
                    </van-tabbar>
                </template>

                <van-empty
                        image="network"
                        v-else />
            </van-config-provider>
        </div>

        <script>
            const { createApp, ref, onMounted, watch, nextTick } = Vue

            async function requestApi(url, config) {
                const resp = await fetch(url, config)
                if (resp.status !== 200) {
                    throw new Error(`请求失败：${resp.status}`)
                }

                return resp
            }

            dayjs.locale('zh-cn')
            dayjs.extend(dayjs_plugin_relativeTime)

            createApp({
                setup() {
                    const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches

                    const tabActive = ref('config')

                    const settings = ref()
                    async function confirmSettings() {
                        try {
                            vant.showLoadingToast({ message: '加载中...', forbidClick: true, duration: 0 })
                            await requestApi('/api/settings', {
                                method: 'PUT',
                                body: JSON.stringify({ ...settings.value, logHistory: undefined }),
                                headers: { 'Content-Type': 'application/json' }
                            })
                            await refreshSettings()
                            vant.showSuccessToast('修改成功')
                        } catch (e) {
                            vant.showFailToast('无法修改设置')
                            console.error(e)
                            refreshSettings()
                        }
                    }
                    async function refreshSettings() {
                        try {
                            vant.showLoadingToast({ message: '加载中...', forbidClick: true, duration: 0 })
                            settings.value = await (await requestApi('/api/settings')).json()
                            settings.value.logHistory = settings.value.logHistory.reverse()
                            vant.closeToast()
                        } catch (e) {
                            vant.showFailToast('无法获取设置')
                            console.error(e)
                        }
                    }


                    onMounted(async () => {
                        await refreshSettings()
                    })

                    async function uploaderAfterRead(file) {
                        try {
                            vant.showLoadingToast({ message: '加载中...', forbidClick: true, duration: 0 })
                            const formData = new FormData()
                            formData.append('file', file.file)
                            await requestApi('/api/upload/apk', { method: "POST", body: formData })
                            vant.closeToast()
                        } catch (e) {
                            vant.showFailToast('上传apk失败')
                            console.error(e)
                        }
                    }

                    return {
                        dayjs,
                        isDark,
                        tabActive,
                        settings,
                        confirmSettings,
                        uploaderAfterRead,
                    }
                }
            })
                .use(vant)
                .mount('#app')
        </script>
    </body>
</html>
